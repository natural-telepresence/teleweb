<!DOCTYPE html>
<html>
<head>
    <script src="./lib/eventemitter2.min.js"></script>
    <script src="./lib/jquery-2.2.0.min.js"></script>
    <script src="./lib/roslib.min.js"></script>
    <script src="./lib/three.min.js"></script>
    <script>
        // these two lines contain the base64-encoded images to turn on- and off the application.

        var alpha, valpha, z;
        var beta, vbeta, x;
        var gamma, vgamma, y;

        var imuTimer;

        // setup event handler to capture the orientation event and store the most recent data in a variable

        if (window.DeviceOrientationEvent) {
            // Listen for the deviceorientation event and handle the raw data
            window.addEventListener('deviceorientation', function(eventData) {
                // gamma is the left-to-right tilt in degrees, where right is positive
                gamma = eventData.gamma;

                // beta is the front-to-back tilt in degrees, where front is positive
                beta = eventData.beta;

                // alpha is the compass direction the device is facing in degrees
                alpha = eventData.alpha;

            }, false);
        };

        // setup event handler to capture the acceleration event and store the most recent data in a variable

        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', deviceMotionHandler, false);
        } else {
            window.alert("acceleration measurements Not supported.");
        }

        function deviceMotionHandler(eventData) {
            // Grab the acceleration from the results
            var acceleration = eventData.acceleration;
            x = acceleration.x;
            y = acceleration.y;
            z = acceleration.z;

            // Grab the rotation rate from the results
            var rotation = eventData.rotationRate;
            vgamma = rotation.gamma;  
            vbeta = rotation.beta;
            valpha = rotation.alpha;
        }


        // setup connection to the ROS server and prepare the topic
        var ros = new ROSLIB.Ros();

        ros.on('connection', function() { console.log('Connected to websocket server.');});

        ros.on('error', function(error) { console.log('Error connecting to websocket server: ', error); window.alert('Error connecting to websocket server'); });

        ros.on('close', function() { console.log('Connection to websocket server closed.');});

        var imuTopic = new ROSLIB.Topic({
            ros : ros,
            name : '/cardboard/imu',
            messageType : 'sensor_msgs/Imu'
        });
    </script>
</head>

<body>
    <script>
        function imusnapshot() {
        var beta_radian = ((beta + 360) / 360 * 2 * Math.PI) % (2 * Math.PI);
        var gamma_radian = ((gamma + 360) / 360 * 2 * Math.PI) % (2 * Math.PI);
        var alpha_radian = ((alpha + 360) / 360 * 2 * Math.PI) % (2 * Math.PI);
        var eurlerpose = new THREE.Euler(beta_radian, gamma_radian, alpha_radian);
        var quaternionpose = new THREE.Quaternion;
        quaternionpose.setFromEuler(eurlerpose);

        var imuMessage = new ROSLIB.Message({
            header : {
                frame_id : "world"
            },
            orientation : {
                x : quaternionpose.x,
                y : quaternionpose.y,
                z : quaternionpose.z,
                w : quaternionpose.w
            },
            orientation_covariance : [0,0,0,0,0,0,0,0,0],
            angular_velocity : {
                x : vbeta,
                y : vgamma,
                z : valpha,
            },
            angular_velocity_covariance  : [0,0,0,0,0,0,0,0,0],
            linear_acceleration : {
                x : x,
                y : y,
                z : z,
            },
            linear_acceleration_covariance  : [0,0,0,0,0,0,0,0,0],
        });

        imuTopic.publish(imuMessage);
        }
        $(function(){
            if(imuTimer == null) {
                ros.connect("ws://" + window.location.hostname + ":9090");
                imuTimer = setInterval(function(){
                    imusnapshot();
                }, 20);
            } 
        });
    </script>
</body>
</html>
